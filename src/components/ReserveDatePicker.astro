---
const {
  d = "5f5b6ce3-89da-4cb3-b8d4-6a2688b9c0d5",
  parkSlug = "fourwardcast-flippin-ar",
  buttonText = "Search Now",
} = Astro.props;

const baseUrl = `https://www.roverpass.com/c/${parkSlug}/booking/`;
---

<div class="reserve-picker" data-base-url={baseUrl} data-d={d}>
  <input
    class="reserve-input"
    type="text"
    placeholder="Select dates"
    autocomplete="off"
    inputmode="none"
  />
  <button class="reserve-button" type="button">
    {buttonText}
  </button>
</div>

<script is:inline>
(function() {
  // Format Date -> YYYY-MM-DD
  function toYMD(date) {
    var y = date.getFullYear();
    var m = String(date.getMonth() + 1).padStart(2, "0");
    var d = String(date.getDate()).padStart(2, "0");
    return y + "-" + m + "-" + d;
  }

  var root = document.currentScript?.previousElementSibling;
  var input = root?.querySelector(".reserve-input");
  var btn = root?.querySelector(".reserve-button");

  if (!root || !input || !btn) {
    console.warn("ReserveDatePicker: elements not found");
    return;
  }

  var baseUrl = root.getAttribute("data-base-url") || "";
  var dParam = root.getAttribute("data-d") || "";

  var startDate = null;
  var endDate = null;

  function openRoverpass() {
    var url = new URL(baseUrl);
    url.searchParams.set("d", dParam);
    if (startDate && endDate) {
      url.searchParams.set("check_in", toYMD(startDate));
      url.searchParams.set("check_out", toYMD(endDate));
    }
    window.open(url.toString(), "_blank", "noopener,noreferrer");
  }

  btn.addEventListener("click", openRoverpass);

  // Shared CDN loader â€” only loads once, queues callbacks for each picker
  if (!window.__litepickerQueue) {
    window.__litepickerQueue = [];
    window.__litepickerReady = false;

    var css = document.createElement("link");
    css.rel = "stylesheet";
    css.href = "https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css";
    document.head.appendChild(css);

    var script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js";
    script.onload = function() {
      window.__litepickerReady = true;
      window.__litepickerQueue.forEach(function(fn) { fn(); });
      window.__litepickerQueue = [];
    };
    document.head.appendChild(script);
  }

  function initPicker() {
    var Litepicker = window.Litepicker;
    if (!Litepicker) { return; }
    var isMobile = window.matchMedia("(max-width: 900px)").matches;
    new Litepicker({
      element: input,
      parentEl: root,
      singleMode: false,
      numberOfMonths: isMobile ? 1 : 2,
      numberOfColumns: isMobile ? 1 : 2,
      format: "MM/DD/YYYY",
      setup: function(picker) {
        picker.on("selected", function(date1, date2) {
          startDate = date1?.dateInstance ?? null;
          endDate = date2?.dateInstance ?? null;
        });
      },
    });
  }

  if (window.__litepickerReady) {
    initPicker();
  } else {
    window.__litepickerQueue.push(initPicker);
  }
})();
</script>

<style>
  .reserve-picker {
    position: relative;
    display: flex;
    align-items: stretch;
    gap: 0;
    max-width: 520px;
    width: 100%;
  }

  .reserve-input {
    flex: 1;
    padding: 0.8rem 0.9rem;
    border: 1px solid rgb(0, 0, 0);
    border-right: 0;
    border-radius: 999px 0 0 999px;
    font-size: 1rem;
    background: rgb(255, 234, 196);
  }

  .reserve-button {
    padding: 0.8rem 1rem;
    border-left: 0;
    color: rgb(255, 234, 196);
    border: 1px solid rgb(0, 0, 0);
    background: rgb(81, 69, 38);
    border-radius: 0 999px 999px 0;
    font-weight: 700;
    cursor: pointer;
  }

  .reserve-button:hover {
    background: rgb(80, 86, 53);
  }

  /* Litepicker dropdown positioning */
  .reserve-picker :global(.litepicker) {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    z-index: 100;
    max-width: 100vw;
    overflow-x: auto;
    margin-top: 4px;
  }

  @media (max-width: 520px) {
    .reserve-picker {
      max-width: 100%;
      flex-wrap: wrap;
      border-radius: 999px;
    }

    .reserve-input {
      font-size: 0.95rem;
      width: 100%;
      border-right: 1px solid rgb(0, 0, 0);
      border-radius: 999px;
    }

    .reserve-button {
      width: 100%;
      min-width: 0;
      margin-top: 10px;
      border-left: 1px solid rgb(0, 0, 0);
      border-radius: 999px;
    }
  }
</style>
